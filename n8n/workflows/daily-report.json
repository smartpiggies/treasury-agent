{
  "name": "Daily Treasury Report",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "trigger",
      "name": "Daily 9 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "jsCode": "// Fetch treasury balance from Circle Gateway\nconst apiKey = $env.CIRCLE_API_KEY;\nconst treasuryAddress = $env.CIRCLE_TREASURY_ADDRESS;\n\nif (!apiKey) {\n  throw new Error('CIRCLE_API_KEY not configured');\n}\n\nconst response = await fetch('https://api.circle.com/v1/w3s/wallets/balances', {\n  headers: {\n    'Authorization': `Bearer ${apiKey}`,\n    'Content-Type': 'application/json',\n  },\n});\n\nif (!response.ok) {\n  throw new Error(`Circle API error: ${response.status}`);\n}\n\nconst data = await response.json();\n\n// Calculate total USDC across all chains\nlet totalUsdc = 0;\nconst chainBalances = [];\n\nif (data.data && data.data.tokenBalances) {\n  for (const balance of data.data.tokenBalances) {\n    if (balance.token.symbol === 'USDC') {\n      const amount = parseFloat(balance.amount);\n      totalUsdc += amount;\n      chainBalances.push({\n        chain: balance.token.blockchain,\n        amount: amount,\n      });\n    }\n  }\n}\n\nreturn {\n  totalUsdc,\n  chainBalances,\n  timestamp: new Date().toISOString(),\n};"
      },
      "id": "fetch-balance",
      "name": "Fetch Circle Balance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "jsCode": "// Fetch ETH/USDC price from Uniswap v3 subgraph\nconst query = `{\n  pool(id: \"0x8ad599c3a0ff1de082011efddc58f1908eb6e6d8\") {\n    token0Price\n    token1Price\n    token0 { symbol }\n    token1 { symbol }\n  }\n}`;\n\nconst response = await fetch(\n  'https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v3',\n  {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ query }),\n  }\n);\n\nconst data = await response.json();\nconst pool = data.data?.pool;\n\nif (!pool) {\n  throw new Error('Failed to fetch Uniswap pool data');\n}\n\n// ETH/USDC pool - token0 is USDC, token1 is ETH\n// token0Price = how many USDC per ETH\nconst ethPrice = parseFloat(pool.token0Price);\n\nreturn {\n  ethPrice,\n  timestamp: new Date().toISOString(),\n};"
      },
      "id": "fetch-price",
      "name": "Fetch ETH Price",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 200]
    },
    {
      "parameters": {
        "jsCode": "// Combine balance and price data into report\nconst balanceData = $('Fetch Circle Balance').first().json;\nconst priceData = $('Fetch ETH Price').first().json;\n\nconst formatCurrency = (n) => `$${n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n\nconst chainList = balanceData.chainBalances\n  .map(c => `  â€¢ ${c.chain}: ${formatCurrency(c.amount)}`)\n  .join('\\n');\n\nconst report = {\n  title: 'Daily Treasury Report',\n  date: new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),\n  totalBalance: formatCurrency(balanceData.totalUsdc),\n  ethPrice: formatCurrency(priceData.ethPrice),\n  chainBreakdown: chainList,\n};\n\nreturn report;"
      },
      "id": "format-report",
      "name": "Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DISCORD_WEBHOOK_REPORTS }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"embeds\": [{\n    \"title\": \"{{ $json.title }}\",\n    \"description\": \"{{ $json.date }}\",\n    \"color\": 3447003,\n    \"fields\": [\n      {\n        \"name\": \"Total Balance\",\n        \"value\": \"{{ $json.totalBalance }}\",\n        \"inline\": true\n      },\n      {\n        \"name\": \"ETH Price\",\n        \"value\": \"{{ $json.ethPrice }}\",\n        \"inline\": true\n      },\n      {\n        \"name\": \"Chain Breakdown\",\n        \"value\": \"{{ $json.chainBreakdown }}\"\n      }\n    ],\n    \"footer\": {\n      \"text\": \"Treasury Ops Bot\"\n    },\n    \"timestamp\": \"{{ $now.toISO() }}\"\n  }]\n}"
      },
      "id": "discord-report",
      "name": "Send to Discord",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 100]
    },
    {
      "parameters": {
        "jsCode": "// Save balance to Appwrite for history\nconst balanceData = $('Fetch Circle Balance').first().json;\nconst priceData = $('Fetch ETH Price').first().json;\n\nconst endpoint = $env.APPWRITE_ENDPOINT;\nconst projectId = $env.APPWRITE_PROJECT_ID;\nconst apiKey = $env.APPWRITE_API_KEY;\nconst databaseId = $env.APPWRITE_DATABASE_ID || 'treasury';\n\nif (!endpoint || !apiKey) {\n  console.log('Appwrite not configured, skipping save');\n  return { saved: false };\n}\n\n// Save each chain balance\nfor (const chain of balanceData.chainBalances) {\n  await fetch(\n    `${endpoint}/databases/${databaseId}/collections/balances/documents`,\n    {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Appwrite-Project': projectId,\n        'X-Appwrite-Key': apiKey,\n      },\n      body: JSON.stringify({\n        documentId: 'unique()',\n        data: {\n          timestamp: new Date().toISOString(),\n          chain: chain.chain,\n          token: 'USDC',\n          balance: chain.amount.toString(),\n          balance_usd: chain.amount,\n          source: 'circle',\n        },\n      }),\n    }\n  );\n}\n\n// Save ETH price\nawait fetch(\n  `${endpoint}/databases/${databaseId}/collections/price_history/documents`,\n  {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'X-Appwrite-Project': projectId,\n      'X-Appwrite-Key': apiKey,\n    },\n    body: JSON.stringify({\n      documentId: 'unique()',\n      data: {\n        timestamp: new Date().toISOString(),\n        token: 'ETH',\n        price_usd: priceData.ethPrice,\n        source: 'uniswap',\n      },\n    }),\n  }\n);\n\nreturn { saved: true, timestamp: new Date().toISOString() };"
      },
      "id": "save-appwrite",
      "name": "Save to Appwrite",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 300]
    }
  ],
  "connections": {
    "Daily 9 AM": {
      "main": [
        [
          { "node": "Fetch Circle Balance", "type": "main", "index": 0 },
          { "node": "Fetch ETH Price", "type": "main", "index": 0 }
        ]
      ]
    },
    "Fetch Circle Balance": {
      "main": [
        [{ "node": "Format Report", "type": "main", "index": 0 }]
      ]
    },
    "Fetch ETH Price": {
      "main": [
        [{ "node": "Format Report", "type": "main", "index": 0 }]
      ]
    },
    "Format Report": {
      "main": [
        [
          { "node": "Send to Discord", "type": "main", "index": 0 },
          { "node": "Save to Appwrite", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
